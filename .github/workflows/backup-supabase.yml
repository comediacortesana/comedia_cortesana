name: Backup Supabase Database

on:
  # Ejecutar diariamente a las 2:00 AM UTC (3:00 AM CET / 9:00 PM PST del dÃ­a anterior)
  schedule:
    - cron: '0 2 * * *'
  
  # Permitir ejecuciÃ³n manual desde GitHub Actions
  workflow_dispatch:
    inputs:
      format:
        description: 'Formato del backup (json o db)'
        required: false
        default: 'json'
        type: choice
        options:
          - json
          - db

permissions:
  contents: write  # Necesario para hacer commit y push

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para hacer push
          ref: ${{ github.ref }}
      
      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          # Instalar desde requirements.txt de scripts si existe, sino instalar directamente
          if [ -f scripts/requirements.txt ]; then
            pip install -r scripts/requirements.txt
          else
            pip install supabase python-dotenv
          fi
      
      - name: ðŸ’¾ Ejecutar backup
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          # Crear directorio para backups
          mkdir -p backups
          
          # Generar nombre de archivo con fecha
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          FORMAT="${{ github.event.inputs.format || 'json' }}"
          
          if [ "$FORMAT" = "db" ]; then
            OUTPUT_FILE="backups/backup_supabase_${TIMESTAMP}.db"
            python scripts/backup_supabase_completo.py --output "$OUTPUT_FILE" --format sqlite
          else
            OUTPUT_FILE="backups/backup_supabase_${TIMESTAMP}.json"
            python scripts/backup_supabase_completo.py --output "$OUTPUT_FILE" --format json
          fi
          
          echo "âœ… Backup completado: $OUTPUT_FILE"
          echo "BACKUP_FILE=$OUTPUT_FILE" >> $GITHUB_ENV
      
      - name: ðŸ”§ Configurar Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: ðŸ“ Commit y Push del backup
        run: |
          # Obtener el nombre de la rama actual
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "ðŸ“Œ Rama actual: $BRANCH"
          
          # Verificar si hay cambios
          git status
          
          # Agregar el archivo de backup
          git add "${{ env.BACKUP_FILE }}"
          
          # Verificar si hay cambios para commitear
          if git diff --staged --quiet; then
            echo "âš ï¸ No hay cambios para commitear"
          else
            # Crear commit con mensaje descriptivo
            TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S UTC")
            COMMIT_MSG="ðŸ”„ Backup automÃ¡tico de Supabase - $TIMESTAMP"
            
            git commit -m "$COMMIT_MSG"
            
            # Hacer push al repositorio (a la rama actual)
            git push origin "$BRANCH"
            
            echo "âœ… Backup commitado y pusheado exitosamente a la rama $BRANCH"
          fi
      
      - name: ðŸ§¹ Limpiar backups antiguos (opcional)
        run: |
          # Mantener solo los Ãºltimos 30 backups
          cd backups
          ls -t backup_supabase_*.json backup_supabase_*.db 2>/dev/null | tail -n +31 | xargs -r rm -f
          cd ..
          
          # Si se eliminaron archivos, commitear los cambios
          if [ -n "$(git status --porcelain)" ]; then
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            git add backups/
            git commit -m "ðŸ§¹ Limpiar backups antiguos (mantener Ãºltimos 30)" || true
            git push origin "$BRANCH" || true
          fi
        continue-on-error: true
      
      - name: ðŸ“Š Mostrar resumen
        run: |
          echo "## ðŸ“Š Resumen del Backup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Backup completado exitosamente" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Archivo: \`${{ env.BACKUP_FILE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Fecha: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… El backup ha sido guardado en el repositorio y estÃ¡ disponible en el historial de commits." >> $GITHUB_STEP_SUMMARY
