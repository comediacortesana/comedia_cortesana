<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ obra.titulo }} - Teatro Espa√±ol del Siglo de Oro</title>
    <style>
        /* Colores principales */
        :root {
            --beige-bg: #F5E6D3;
            --beige-light: #FAF3E9;
            --warm-red: #C17767;
            --warm-red-dark: #A55E4F;
            --warm-red-light: #D98B7A;
            --text-dark: #4A3428;
            --text-medium: #7A6552;
            --border-color: #E0D4C4;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--beige-bg);
            color: var(--text-dark);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--beige-light);
            border: 2px solid var(--warm-red);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(193, 119, 103, 0.2);
        }
        
        /* BARRA SUPERIOR MINIMALISTA */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .back-link {
            background: var(--text-medium);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .back-link:hover {
            background: var(--text-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(74, 52, 40, 0.3);
        }
        
        .obra-id {
            font-size: 0.9rem;
            color: var(--text-medium);
            background: var(--beige-light);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            color: var(--warm-red-dark);
            font-weight: 300;
            letter-spacing: 1px;
        }
        .header p {
            color: var(--text-medium);
            font-size: 1rem;
        }
        
        .obra-info {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid var(--warm-red);
            box-shadow: 0 4px 12px rgba(193, 119, 103, 0.1);
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .info-card {
            background: #FFF9F5;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--warm-red-light);
            box-shadow: 0 2px 8px rgba(193, 119, 103, 0.1);
        }
        .info-card h3 {
            color: var(--warm-red-dark);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .info-item {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 600;
            color: var(--warm-red-dark);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .info-value {
            color: var(--text-dark);
            font-weight: 500;
            text-align: right;
            max-width: 60%;
        }
        .fuente-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .fuente-fuentesxi {
            background: var(--warm-red-light);
            color: white;
        }
        .fuente-catcom {
            background: var(--warm-red);
            color: white;
        }
        .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .stat-card {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--warm-red-light);
            box-shadow: 0 4px 12px rgba(193, 119, 103, 0.1);
            min-width: 120px;
        }
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--warm-red-dark);
            display: block;
        }
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 5px;
        }
        .section {
            margin: 30px 0;
        }
        .section h2 {
            color: var(--warm-red-dark);
            border-bottom: 2px solid var(--warm-red-light);
            padding-bottom: 10px;
            font-size: 1.3rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .list-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--warm-red);
            box-shadow: 0 2px 8px rgba(193, 119, 103, 0.1);
            transition: all 0.3s ease;
        }
        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(193, 119, 103, 0.15);
        }
        .list-item h4 {
            margin: 0 0 15px 0;
            color: var(--warm-red-dark);
            font-size: 1.1rem;
            font-weight: 600;
        }
        .list-item p {
            margin: 8px 0;
            color: var(--text-dark);
            line-height: 1.5;
        }
        .list-item a {
            color: var(--warm-red);
            text-decoration: none;
            font-weight: 500;
        }
        .list-item a:hover {
            color: var(--warm-red-dark);
            text-decoration: underline;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-medium);
            background: white;
            border-radius: 15px;
            border: 2px dashed var(--border-color);
            box-shadow: 0 2px 8px rgba(193, 119, 103, 0.1);
        }
        .empty-state h3 {
            color: var(--warm-red-dark);
            margin-bottom: 10px;
        }
        
        /* BOTONES DE EDICI√ìN */
        .edit-btn, .save-btn, .cancel-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .edit-btn {
            background: var(--warm-red);
            color: white;
        }
        
        .edit-btn:hover {
            background: var(--warm-red-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(193, 119, 103, 0.3);
        }
        
        .save-btn {
            background: #27ae60;
            color: white;
        }
        
        .save-btn:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }
        
        .cancel-btn {
            background: var(--text-medium);
            color: white;
        }
        
        .cancel-btn:hover {
            background: var(--text-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(74, 52, 40, 0.3);
        }
        
        /* CAMPOS EDITABLES */
        .editable {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .editable:hover {
            background: rgba(193, 119, 103, 0.1);
        }
        
        .editing-mode .editable {
            background: white;
            border: 2px solid var(--warm-red);
            cursor: text;
        }
        
        .editable-input {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--warm-red);
            border-radius: 4px;
            font-family: inherit;
            font-size: inherit;
            color: var(--text-dark);
            background: white;
        }
        
        .editable-textarea {
            width: 100%;
            min-height: 100px;
            padding: 8px;
            border: 2px solid var(--warm-red);
            border-radius: 4px;
            font-family: inherit;
            font-size: inherit;
            color: var(--text-dark);
            background: white;
            resize: vertical;
        }
        
        .editable-select {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--warm-red);
            border-radius: 4px;
            font-family: inherit;
            font-size: inherit;
            color: var(--text-dark);
            background: white;
            cursor: pointer;
        }
        
        /* MENSAJES DE FEEDBACK */
        .feedback-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .feedback-success {
            background: #27ae60;
            color: white;
        }
        
        .feedback-error {
            background: #e74c3c;
            color: white;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
            
            .top-bar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .stats {
                gap: 10px;
            }
            
            .stat-card {
                min-width: 100px;
                padding: 12px 15px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .info-value {
                text-align: left;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        {% csrf_token %}
        <!-- BARRA SUPERIOR MINIMALISTA -->
        <div class="top-bar">
            <a href="/obras/catalogo/" class="back-link">‚Üê Volver al cat√°logo</a>
            <div style="display: flex; gap: 10px; align-items: center;">
                {% if user.is_authenticated %}
                <button id="editBtn" class="edit-btn">‚úèÔ∏è Editar</button>
                <button id="saveBtn" class="save-btn" style="display: none;">üíæ Guardar</button>
                <button id="cancelBtn" class="cancel-btn" style="display: none;">‚ùå Cancelar</button>
                {% endif %}
                <div class="obra-id">ID: {{ obra.id }}</div>
            </div>
        </div>
        
        <div class="header">
            <h1>{{ obra.titulo }}</h1>
            <p>Detalles de la obra teatral</p>
        </div>

        <div class="obra-info">
            <div class="info-grid">
                <div class="info-card">
                    <h3>üìö Informaci√≥n B√°sica</h3>
                    <div class="info-item">
                        <span class="info-label">T√≠tulo:</span>
                        <span class="info-value editable" data-field="titulo" data-type="text">{{ obra.titulo }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">T√≠tulo Limpio:</span>
                        <span class="info-value editable" data-field="titulo_limpio" data-type="text">{{ obra.titulo_limpio }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Autor:</span>
                        <span class="info-value editable" data-field="autor" data-type="autor-select" data-autor-id="{{ obra.autor.id|default:'' }}">{{ obra.autor.nombre|default:"Desconocido" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">G√©nero:</span>
                        <span class="info-value editable" data-field="genero" data-type="text">{{ obra.genero|default:"No especificado" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Tipo de obra:</span>
                        <span class="info-value editable" data-field="tipo_obra" data-type="select">{{ obra.tipo_obra|default:"No especificado" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Idioma:</span>
                        <span class="info-value editable" data-field="idioma" data-type="text">{{ obra.idioma|default:"Espa√±ol" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Actos:</span>
                        <span class="info-value editable" data-field="actos" data-type="number">{{ obra.actos|default:"No especificado" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Versos:</span>
                        <span class="info-value editable" data-field="versos" data-type="number">{{ obra.versos|default:"No especificado" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Fecha creaci√≥n:</span>
                        <span class="info-value editable" data-field="fecha_creacion_estimada" data-type="text">{{ obra.fecha_creacion_estimada|default:"No especificada" }}</span>
                    </div>
                </div>

                <div class="info-card">
                    <h3>üîç Origen y Clasificaci√≥n</h3>
                    <div class="info-item">
                        <span class="info-label">Fuente principal:</span>
                        <span class="fuente-badge fuente-{{ obra.fuente_principal|lower }}">
                            {{ obra.fuente_principal }}
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Tema:</span>
                        <span class="info-value editable" data-field="tema" data-type="text">{{ obra.tema|default:"No especificado" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">M√∫sica conservada:</span>
                        <span class="info-value editable" data-field="musica_conservada" data-type="checkbox">
                            {% if obra.musica_conservada %}‚úÖ S√≠{% else %}‚ùå No{% endif %}
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Compositor:</span>
                        <span class="info-value editable" data-field="compositor" data-type="text">{{ obra.compositor|default:"No especificado" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Mecenas:</span>
                        <span class="info-value editable" data-field="mecenas" data-type="text">{{ obra.mecenas|default:"No especificado" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Bibliotecas m√∫sica:</span>
                        <span class="info-value editable" data-field="bibliotecas_musica" data-type="text">{{ obra.bibliotecas_musica|default:"No especificado" }}</span>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <h3>üìù T√≠tulos Alternativos</h3>
                <p class="editable" data-field="titulo_alternativo" data-type="textarea">{{ obra.titulo_alternativo|default:"No especificado" }}</p>
            </div>

            <div class="info-card">
                <h3>üìñ Edici√≥n Pr√≠ncipe</h3>
                <p class="editable" data-field="edicion_principe" data-type="textarea">{{ obra.edicion_principe|default:"No especificado" }}</p>
            </div>

            <div class="info-card">
                <h3>üìö Notas Bibliogr√°ficas</h3>
                <p class="editable" data-field="notas_bibliograficas" data-type="textarea">{{ obra.notas_bibliograficas|default:"No especificado" }}</p>
            </div>

            <div class="info-card">
                <h3>üìù Notas Adicionales</h3>
                <p class="editable" data-field="notas" data-type="textarea">{{ obra.notas|default:"No especificado" }}</p>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_manuscritos }}</div>
                <div>Manuscritos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_representaciones }}</div>
                <div>Representaciones</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.lugares_unicos }}</div>
                <div>Lugares √∫nicos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.fechas_unicas }}</div>
                <div>Fechas √∫nicas</div>
            </div>
        </div>

        {% if manuscritos %}
        <div class="section">
            <h2>üìú Manuscritos</h2>
            {% for manuscrito in manuscritos %}
            <div class="list-item">
                <h4>üìç {{ manuscrito.ubicacion|default:"Ubicaci√≥n no especificada" }}</h4>
                {% if manuscrito.signatura %}
                <p><strong>Signatura:</strong> {{ manuscrito.signatura }}</p>
                {% endif %}
                {% if manuscrito.url_digitalizacion %}
                <p><strong>Digitalizaci√≥n:</strong> <a href="{{ manuscrito.url_digitalizacion }}" target="_blank" style="color: #3498db;">Ver enlace</a></p>
                {% endif %}
                {% if manuscrito.notas %}
                <p><strong>Notas:</strong> {{ manuscrito.notas }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if representaciones %}
        <div class="section">
            <h2>üé™ Representaciones</h2>
            {% for representacion in representaciones %}
            <div class="list-item">
                <h4>üìÖ {{ representacion.fecha_formateada|default:representacion.fecha|default:"Fecha no especificada" }}</h4>
                {% if representacion.lugar %}
                <p><strong>Lugar:</strong> {{ representacion.lugar.nombre }}</p>
                {% endif %}
                {% if representacion.compa√±ia %}
                <p><strong>Compa√±√≠a:</strong> {{ representacion.compa√±ia }}</p>
                {% endif %}
                {% if representacion.mecenas %}
                <p><strong>Mecenas:</strong> {{ representacion.mecenas }}</p>
                {% endif %}
                {% if representacion.observaciones %}
                <p><strong>Observaciones:</strong> {{ representacion.observaciones }}</p>
                {% endif %}
                {% if representacion.fuente %}
                <p><strong>Fuente:</strong> <span class="fuente-badge fuente-{{ representacion.fuente|lower }}">{{ representacion.fuente }}</span></p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if not manuscritos and not representaciones %}
        <div class="empty-state">
            <h3>üì≠ Sin datos adicionales</h3>
            <p>No hay manuscritos ni representaciones registradas para esta obra.</p>
        </div>
        {% endif %}

        <!-- SECCI√ìN DE COMENTARIOS -->
        {% if user.is_authenticated %}
        <div class="section">
            <h2>üí¨ Comentarios</h2>
            
            <!-- Formulario para nuevo comentario -->
            <div class="info-card" style="margin-bottom: 20px;">
                <h3>‚úçÔ∏è Agregar Comentario</h3>
                <form id="commentForm" style="margin-top: 15px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; color: var(--warm-red-dark); margin-bottom: 8px;">
                            T√≠tulo del comentario:
                        </label>
                        <input type="text" 
                               id="commentTitle" 
                               name="titulo"
                               class="editable-input" 
                               placeholder="Ej: An√°lisis tem√°tico, Observaci√≥n hist√≥rica..."
                               required
                               style="width: 100%;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; color: var(--warm-red-dark); margin-bottom: 8px;">
                            Comentario:
                        </label>
                        <textarea id="commentText" 
                                  name="comentario"
                                  class="editable-textarea" 
                                  placeholder="Comparte tus observaciones, an√°lisis o descubrimientos sobre esta obra..."
                                  required
                                  style="min-height: 120px;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" 
                                   id="commentPublic" 
                                   name="es_publico"
                                   style="margin-right: 8px;">
                            <span style="color: var(--text-dark);">
                                <strong>Hacer p√∫blico</strong> (visible para todos los usuarios en la p√°gina de inicio)
                            </span>
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="save-btn">
                            üíæ Publicar Comentario
                        </button>
                        <button type="button" class="cancel-btn" onclick="document.getElementById('commentForm').reset()">
                            üîÑ Limpiar
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Lista de comentarios de esta obra -->
            <div id="commentsContainer">
                <!-- Los comentarios se cargar√°n aqu√≠ din√°micamente -->
            </div>
        </div>
        {% else %}
        <div class="section">
            <div class="info-card" style="text-align: center;">
                <h3>üí¨ Comentarios</h3>
                <p style="color: var(--text-medium); margin: 15px 0;">
                    <a href="/usuarios/login/" style="color: var(--warm-red); font-weight: 600;">Inicia sesi√≥n</a> 
                    para ver y agregar comentarios sobre esta obra.
                </p>
            </div>
        </div>
        {% endif %}
    </div>

    {% if user.is_authenticated %}
    <script>
        // Estado de edici√≥n
        let isEditMode = false;
        let originalValues = {};
        
        // Elementos
        const editBtn = document.getElementById('editBtn');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const editableFields = document.querySelectorAll('.editable');
        const container = document.querySelector('.container');
        
        // Tipos de obra disponibles
        const tipoObraOptions = [
            'comedia', 'auto', 'zarzuela', 'entremes', 'tragedia', 
            'loa', 'sainete', 'baile', 'otro'
        ];
        
        // Autores disponibles
        const autoresDisponibles = [
            {% for autor in autores %}
            { id: {{ autor.id }}, nombre: "{{ autor.nombre|escapejs }}" }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Funci√≥n para mostrar mensajes de feedback
        function showFeedback(message, isSuccess = true) {
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = `feedback-message feedback-${isSuccess ? 'success' : 'error'}`;
            feedbackDiv.textContent = message;
            document.body.appendChild(feedbackDiv);
            
            setTimeout(() => {
                feedbackDiv.remove();
            }, 3000);
        }
        
        // Funci√≥n para activar modo edici√≥n
        function enableEditMode() {
            isEditMode = true;
            container.classList.add('editing-mode');
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            
            // Convertir campos editables en inputs
            editableFields.forEach(field => {
                const fieldName = field.dataset.field;
                const fieldType = field.dataset.type;
                const currentValue = field.textContent.trim();
                
                // Guardar valor original
                originalValues[fieldName] = currentValue;
                
                // Crear el elemento de edici√≥n apropiado
                let editElement;
                
                if (fieldType === 'textarea') {
                    editElement = document.createElement('textarea');
                    editElement.className = 'editable-textarea';
                    editElement.value = currentValue === 'No especificado' ? '' : currentValue;
                } else if (fieldType === 'select') {
                    editElement = document.createElement('select');
                    editElement.className = 'editable-select';
                    
                    tipoObraOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option;
                        optionElement.textContent = option.charAt(0).toUpperCase() + option.slice(1);
                        if (option === currentValue.toLowerCase()) {
                            optionElement.selected = true;
                        }
                        editElement.appendChild(optionElement);
                    });
                } else if (fieldType === 'autor-select') {
                    editElement = document.createElement('select');
                    editElement.className = 'editable-select';
                    
                    // Obtener el ID del autor actual del atributo data
                    const currentAutorId = field.dataset.autorId;
                    
                    // Agregar opci√≥n vac√≠a
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = 'Seleccionar autor...';
                    if (!currentAutorId) {
                        emptyOption.selected = true;
                    }
                    editElement.appendChild(emptyOption);
                    
                    // Agregar todos los autores
                    autoresDisponibles.forEach(autor => {
                        const optionElement = document.createElement('option');
                        optionElement.value = autor.id;
                        optionElement.textContent = autor.nombre;
                        if (autor.id == currentAutorId) {
                            optionElement.selected = true;
                        }
                        editElement.appendChild(optionElement);
                    });
                } else if (fieldType === 'checkbox') {
                    editElement = document.createElement('input');
                    editElement.type = 'checkbox';
                    editElement.checked = currentValue.includes('‚úÖ');
                    editElement.style.width = 'auto';
                } else if (fieldType === 'number') {
                    editElement = document.createElement('input');
                    editElement.type = 'number';
                    editElement.className = 'editable-input';
                    editElement.value = currentValue === 'No especificado' ? '' : currentValue;
                } else {
                    editElement = document.createElement('input');
                    editElement.type = 'text';
                    editElement.className = 'editable-input';
                    editElement.value = currentValue === 'No especificado' ? '' : currentValue;
                }
                
                editElement.dataset.field = fieldName;
                editElement.dataset.type = fieldType;
                
                // Reemplazar el span/p con el elemento de edici√≥n
                field.replaceWith(editElement);
            });
        }
        
        // Funci√≥n para desactivar modo edici√≥n
        function disableEditMode(restore = false) {
            isEditMode = false;
            container.classList.remove('editing-mode');
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            
            // Restaurar campos editables
            const editInputs = document.querySelectorAll('.editable-input, .editable-textarea, .editable-select, input[type="checkbox"]');
            editInputs.forEach(input => {
                const fieldName = input.dataset.field;
                const fieldType = input.dataset.type;
                let value;
                let autorId = null;
                
                if (fieldType === 'checkbox') {
                    value = input.checked ? '‚úÖ S√≠' : '‚ùå No';
                } else if (fieldType === 'autor-select') {
                    // Para autor, obtener el nombre del autor seleccionado
                    const selectedAutorId = input.value;
                    if (selectedAutorId) {
                        const selectedAutor = autoresDisponibles.find(a => a.id == selectedAutorId);
                        value = selectedAutor ? selectedAutor.nombre : 'Desconocido';
                        autorId = selectedAutorId;
                    } else {
                        value = 'Desconocido';
                    }
                } else {
                    value = input.value.trim() || 'No especificado';
                }
                
                // Si estamos restaurando, usar el valor original
                if (restore && originalValues[fieldName]) {
                    value = originalValues[fieldName];
                    // Para autor, tambi√©n restaurar el ID original
                    if (fieldType === 'autor-select') {
                        // Buscar el autor por nombre para obtener su ID
                        const originalAutor = autoresDisponibles.find(a => a.nombre === value);
                        if (originalAutor) {
                            autorId = originalAutor.id;
                        }
                    }
                }
                
                // Crear el elemento apropiado (span o p)
                const displayElement = fieldType === 'textarea' 
                    ? document.createElement('p') 
                    : document.createElement('span');
                    
                displayElement.className = fieldType === 'textarea' ? 'editable' : 'info-value editable';
                displayElement.dataset.field = fieldName;
                displayElement.dataset.type = fieldType;
                displayElement.textContent = value;
                
                // Si es autor, guardar el ID
                if (fieldType === 'autor-select' && autorId) {
                    displayElement.dataset.autorId = autorId;
                }
                
                input.replaceWith(displayElement);
            });
            
            originalValues = {};
        }
        
        // Funci√≥n para guardar cambios
        async function saveChanges() {
            const formData = new FormData();
            
            // Recopilar todos los valores editados
            const editInputs = document.querySelectorAll('.editable-input, .editable-textarea, .editable-select, input[type="checkbox"]');
            editInputs.forEach(input => {
                const fieldName = input.dataset.field;
                let value;
                
                if (input.type === 'checkbox') {
                    value = input.checked ? 'on' : '';
                } else {
                    value = input.value.trim();
                }
                
                formData.append(fieldName, value);
            });
            
            // Agregar CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             '{{ csrf_token }}';
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            try {
                const response = await fetch(window.location.pathname, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
                
                if (response.ok) {
                    disableEditMode(false);
                    showFeedback('‚úÖ Cambios guardados exitosamente', true);
                    
                    // Recargar la p√°gina despu√©s de 1 segundo para mostrar los cambios
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error('Error al guardar los cambios');
                }
            } catch (error) {
                console.error('Error:', error);
                showFeedback('‚ùå Error al guardar los cambios. Por favor, intenta de nuevo.', false);
            }
        }
        
        // Event listeners
        editBtn.addEventListener('click', enableEditMode);
        cancelBtn.addEventListener('click', () => disableEditMode(true));
        saveBtn.addEventListener('click', saveChanges);
        
        // =================== SISTEMA DE COMENTARIOS ===================
        
        // Funci√≥n para cargar comentarios de esta obra
        async function loadObraComments() {
            try {
                const response = await fetch(`/obras/{{ obra.id }}/comentarios/`);
                const data = await response.json();
                
                const container = document.getElementById('commentsContainer');
                
                if (data.success && data.comentarios && data.comentarios.length > 0) {
                    container.innerHTML = data.comentarios.map(comentario => `
                        <div class="list-item">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h4 style="margin: 0;">
                                    ${comentario.titulo}
                                </h4>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    ${comentario.es_publico 
                                        ? '<span class="fuente-badge" style="background: #27ae60;">P√∫blico</span>' 
                                        : '<span class="fuente-badge" style="background: #95a5a6;">Privado</span>'}
                                    ${comentario.es_mio 
                                        ? '<button onclick="deleteComment(' + comentario.id + ')" class="cancel-btn" style="padding: 4px 8px; font-size: 0.75rem;">üóëÔ∏è Eliminar</button>' 
                                        : ''}
                                </div>
                            </div>
                            <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                                <span style="color: var(--warm-red-dark); font-weight: 600;">üë§ ${comentario.usuario}</span>
                                <span style="color: var(--text-medium); font-size: 0.85rem; margin-left: 10px;">üìÖ ${comentario.fecha_creacion}</span>
                            </div>
                            <p style="color: var(--text-dark); line-height: 1.6; white-space: pre-wrap;">${comentario.comentario}</p>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>üìù Sin comentarios a√∫n</h3>
                            <p>S√© el primero en comentar esta obra.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error cargando comentarios:', error);
                document.getElementById('commentsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>‚ö†Ô∏è Error al cargar comentarios</h3>
                        <p>Por favor, intenta recargar la p√°gina.</p>
                    </div>
                `;
            }
        }
        
        // Funci√≥n para guardar un comentario
        async function saveObraComment(event) {
            event.preventDefault();
            
            const titulo = document.getElementById('commentTitle').value.trim();
            const comentario = document.getElementById('commentText').value.trim();
            const esPublico = document.getElementById('commentPublic').checked;
            
            if (!titulo || !comentario) {
                showFeedback('‚ùå Por favor completa todos los campos', false);
                return;
            }
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
            
            try {
                const response = await fetch(`/obras/{{ obra.id }}/comentario/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        titulo: titulo,
                        comentario: comentario,
                        es_publico: esPublico
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showFeedback('‚úÖ Comentario publicado exitosamente', true);
                    document.getElementById('commentForm').reset();
                    loadObraComments(); // Recargar comentarios
                } else {
                    showFeedback('‚ùå ' + (data.error || 'Error al publicar el comentario'), false);
                }
            } catch (error) {
                console.error('Error:', error);
                showFeedback('‚ùå Error al publicar el comentario. Por favor, intenta de nuevo.', false);
            }
        }
        
        // Funci√≥n para eliminar un comentario
        async function deleteComment(comentarioId) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este comentario?')) {
                return;
            }
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
            
            try {
                const response = await fetch(`/obras/comentario/${comentarioId}/eliminar/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showFeedback('‚úÖ Comentario eliminado', true);
                    loadObraComments();
                } else {
                    showFeedback('‚ùå ' + (data.error || 'Error al eliminar el comentario'), false);
                }
            } catch (error) {
                console.error('Error:', error);
                showFeedback('‚ùå Error al eliminar el comentario', false);
            }
        }
        
        // Inicializar sistema de comentarios
        document.getElementById('commentForm').addEventListener('submit', saveObraComment);
        loadObraComments();
        
        // Hacer la funci√≥n deleteComment global para que pueda ser llamada desde el HTML
        window.deleteComment = deleteComment;
    </script>
    {% endif %}
</body>
</html>
